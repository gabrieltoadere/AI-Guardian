<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Barcode Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden { display: none; }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        #productImage { max-width: 200px; margin-top: 10px; }
        .back-button {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: white;
            background-color: #555;
            padding: 10px 15px;
            border-radius: 4px;
        }

        /* ===== Confirmation Section ===== */
        #confirmSection {
            background-color: #f1f8e9;
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
        }

        #questions {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #questions p {
            text-align: left;
            margin: 10px 0 5px;
            font-weight: 500;
            color: #2d3436;
        }

        #questions input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #questions input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
        }

        #saveNotice {
            color: #27ae60;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        #unsafeFoodButton {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        #camera {
            width: 600px;      
            height: 600px;      
            max-width: 100%;
            margin: 20px auto;
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>

<body>
<<<<<<< HEAD
    <h1>Barcode Scanner</h1>

    <div class="button-group">
        <button id="scanButton" onclick="startScanning()">
            <i class="fas fa-barcode"></i>
            Start Scanning
        </button>
    </div>

    <div id="camera" class="hidden"></div>

    <div id="result" class="hidden">
        <div>
            <h2>Product Information</h2>
            <p><strong>Product Name:</strong> <span id="productName">-</span></p>
            <p><strong>Ingredients:</strong> <span id="ingredients">-</span></p>
            <p><strong>Potential Allergens:</strong> <span id="potentialAllergens">-</span></p>
            <p><strong>Nutrient Levels:</strong> <span id="nutrientLevels">-</span></p>
            <p><Strong>Sugar:</Strong> <span id="sugarLevel">-</span></p>
            <img id="productImage" src="" alt="Product Image" class="hidden">
        </div>


        <div id="confirmSection">
            <button id="saftFoodButton" onclick="showQuestions()">Mark this safe food</button>
            <button id="unsafeFoodButton" onclick="saveFood()">Mark this unsafe food</button>
        <p id="notice"></p>	
        <div id="questions" class="hidden">
            <p>How many of this product did you purchase?</p>
            <input type="number" placeholder="type number">
            <p>Food Name:</p>
            <input type="text" id="foodNameInput">
            <button id="confirmButton" onclick="saveFood()">save</button>
        </div>
        <p id="saveNotice"></p>
        </div>
    </div>
=======
<h1>Barcode Scanner</h1>
>>>>>>> ab435bd1de0cc1b971f9473b0f6e09b5124cf09d

<button id="scanButton">Start Scanning</button>

<<<<<<< HEAD
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script>
        //the following code is for scanning barcode
        let scanTimeout = null;
        let lastDetectedCode = null;
        let lastDetectionTime = 0;
        let isCameraInitialized = false;
		let foodName = null;

        function startScanning() {
            document.getElementById('camera').classList.remove('hidden');

            if (!isCameraInitialized) {
                initializeScanner();
                isCameraInitialized = true;
            }

            scanTimeout = setTimeout(() => {
                console.warn("No barcode detected within 14 seconds. Stopping scanner.");
                stopScanner();
                alert("No barcode detected within 14 seconds. Please try again.");
            }, 14000);
        }

        function stopScanner() {
            Quagga.stop();
            document.getElementById('camera').classList.add('hidden');
            clearTimeout(scanTimeout);
            isCameraInitialized = false;
        }


        function initializeScanner() {
            const quaggaConf = {
                inputStream: {
                    target: document.querySelector("#camera"),
                    type: "LiveStream",
                    constraints: {
                        width: { ideal: 1920 },   
                        height: { ideal: 1080 },
                        facingMode: "environment",
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                decoder: {
                    readers: [
                        'code_128_reader',
                        'ean_reader',
                        'ean_8_reader',
                        'upc_reader',
                        'upc_e_reader',
                        'code_39_reader',
                        'code_39_vin_reader',
                        'codabar_reader',
                        'i2of5_reader',
                        '2of5_reader',
                        'code_93_reader'
                    ]
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                locate: true,
                numOfWorkers: 4
            };

            Quagga.init(quaggaConf, function(err) {
                if (err) {
                    console.error("Initialization failed: ", err);
                    return;
                }
                console.log("Initialization successful");
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const currentCode = result.codeResult.code;
                const currentTime = Date.now();

                if (currentCode === lastDetectedCode && (currentTime - lastDetectionTime) < 5000) {
                    return;
                }

                console.log("Detected barcode: ", currentCode);
                stopScanner(); 
                fetchProductInfo(currentCode);
                document.getElementById('result').classList.remove('hidden');
                lastDetectedCode = currentCode;
                lastDetectionTime = currentTime;
            });
        }

        async function fetchProductInfo(barcodeFromScanner = null) {
            const barcode = barcodeFromScanner;
            if (!barcode) {
                alert('Please enter a barcode.');
                return;
            }

            const url = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 1) {
                    const product = data.product;

                    const productName = product.product_name ||
					product.generic_name_en || 
					product.product_name_en ||
					product.product_name_it ||
                    product.generic_name || 
                    product.abbreviated_product_name || 
                    product.brands || 
                    'Unknown Product';

					foodName = productName;	

                    const ingredients = product.ingredients_text_en || product.ingredients_text || product.ingredients_hierarchy || product.ingredients_original_tags || 'No ingredients listed';
					const potentialAllergens = product.allergens || 'No data';
                    const sugarLevel = product.nutriments.sugars +" " + product.nutriments.sugars_unit || product.nutriments.sugars_100g +" " + product.nutriments.sugars_unit || product.nutriments.sugars_value +" " + product.nutriments.sugars_unit || 'No data';
	
                    document.getElementById('productName').textContent = productName;
                    document.getElementById('ingredients').textContent = ingredients;
					document.getElementById('potentialAllergens').textContent = potentialAllergens;
                    document.getElementById('sugarLevel').textContent = sugarLevel;

					const nutrientLevels = product.nutrient_levels || {};
					const nutrientText = Object.entries(nutrientLevels).map(([key, value]) => `${key}: ${value}`).join(", "); 					 
					document.getElementById('nutrientLevels').textContent = nutrientText || "No data";

			
					document.getElementById('productImage').classList.remove('hidden');
                    const imageUrl = product.image_front_small_url || product.selected_images.front.small.it || "https://cdn-icons-png.flaticon.com/512/1178/1178479.png";
					document.getElementById('productImage').src = imageUrl;            

					document.getElementById('camera').classList.add('hidden');
				} else {
                    document.getElementById('productName').textContent = 'Product not found';
                    document.getElementById('ingredients').textContent = '-';
                    document.getElementById('productImage').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching product info:', error);
                alert('Failed to fetch product information. Please try again.');
            }
        }



    //this function is for the mark this safe food button. 
    //after user clicks it, it will ask user to type number of this product they just bought. And user can type product name if the original one is wrong.
	function showQuestions() {
		document.getElementById('questions').classList.remove('hidden');
		document.getElementById('foodNameInput').value = foodName;
	}

    //this is for the confirm button. 
    //after user clicks it, product info, like name, allergen, sugar, so on should be sent to database. 

	function saveFood(){
		document.getElementById('saveNotice').innerHTML = "This product is saved";
	}


    </script>
=======
<div id="camera" class="hidden" style="width:100%;height:300px;background:#ccc;"></div>

<div id="result" class="hidden">
    <h2>Product Information</h2>
    <p><strong>Product Name:</strong> <span id="productName">-</span></p>
    <p><strong>Ingredients:</strong> <span id="ingredients">-</span></p>
    <p><strong>Potential Allergens:</strong> <span id="potentialAllergens">-</span></p>
    <p><strong>Nutrient Levels:</strong> <span id="nutrientLevels">-</span></p>
    <p><strong>Sugar:</strong> <span id="sugarLevel">-</span></p>
    <img id="productImage" src="" alt="Product Image" class="hidden">

    <button id="stopButton">Stop Scanning</button>
</div>

<a href="scanIndex.html" class="back-button">Back to Main</a>

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
let lastDetectedCode = null;
let lastDetectionTime = 0;
let isCameraInitialized = false;

document.getElementById('scanButton').addEventListener('click', startScanning);
document.getElementById('stopButton').addEventListener('click', stopScanning);

function startScanning() {
    document.getElementById('camera').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');

    if (!isCameraInitialized) {
        initializeScanner('environment'); // try back camera first
    } else {
        Quagga.start();
    }
}

function initializeScanner(facingMode) {
    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: {
                width: { min: 640 },
                height: { min: 480 },
                facingMode: facingMode
            }
        },
        decoder: {
            readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader"]
        },
        locate: true
    }, function (err) {
        if (err) {
            console.error("Error initializing scanner:", err);
            if (facingMode === 'environment') {
                console.warn("Retrying with front camera...");
                initializeScanner('user'); // fallback to front cam
            } else {
                alert('Camera initialization failed. Please check permissions or try a different device.');
            }
            return;
        }

        Quagga.start();
        isCameraInitialized = true;
    });

    Quagga.onDetected(processBarcode);
}


let detectionCounts = {};

function processBarcode(result) {
    let code = result.codeResult.code;
    const now = Date.now();

    // Optional Confidence check
    const confidence = result.codeResult.decodedCodes.filter(c => c.error !== undefined)
                      .map(c => c.error)
                      .reduce((a, b) => a + b, 0);

    console.log("Raw Code:", code, " Error Sum:", confidence);

    if(confidence > 10){ 
        // Low quality scan - ignore
        console.log("Ignoring low confidence scan");
        return;
    }

    code = code.trim().replace(/\s/g, '').replace(/[^0-9]/g, '');

    if(code.length < 13){
        code = code.padStart(13, '0');
    }

    console.log("Cleaned Barcode:", code);

    // Debounce - prevent spam scan
    if (now - lastDetectionTime < 2000) { 
        return;
    }

    // Count how many times the same code appears
    detectionCounts[code] = (detectionCounts[code] || 0) + 1;

    console.log(`Detection Count for ${code}:`, detectionCounts[code]);

    if(detectionCounts[code] < 3){
        // Wait until seen 3 times
        return;
    }

    // Reset for next scan
    detectionCounts = {};
    lastDetectedCode = code;
    lastDetectionTime = now;

    fetchProductInfo(code);
}



async function fetchProductInfo(barcode) {
    const url = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        document.getElementById('result').classList.remove('hidden');

        if (data.status === 1) {
            const product = data.product;
            document.getElementById('productName').textContent = product.product_name || 'Unknown';
            document.getElementById('ingredients').textContent = product.ingredients_text || 'No data';
            document.getElementById('potentialAllergens').textContent = product.allergens || 'No data';
            document.getElementById('sugarLevel').textContent = (product.nutriments.sugars || '-') + " " + (product.nutriments.sugars_unit || '');
            document.getElementById('nutrientLevels').textContent = product.nutrient_levels ? 
                Object.entries(product.nutrient_levels).map(([k, v]) => `${k}: ${v}`).join(', ') : 'No data';

            if (product.image_front_small_url) {
                document.getElementById('productImage').src = product.image_front_small_url;
                document.getElementById('productImage').classList.remove('hidden');
            } else {
                document.getElementById('productImage').classList.add('hidden');
            }
        } else {
            document.getElementById('productName').textContent = 'Product not found';
            document.getElementById('ingredients').textContent = '-';
            document.getElementById('potentialAllergens').textContent = '-';
            document.getElementById('sugarLevel').textContent = '-';
            document.getElementById('nutrientLevels').textContent = '-';
            document.getElementById('productImage').classList.add('hidden');
        }

        stopScanning();

    } catch (error) {
        console.error('Fetch error:', error);
        alert('Failed to fetch product info.');
    }
}

function stopScanning() {
    Quagga.stop();

    // Remove all video/canvas from #camera
    const cameraDiv = document.getElementById('camera');
    cameraDiv.innerHTML = ''; 

    document.getElementById('camera').classList.add('hidden');

    isCameraInitialized = false;  // Allow re-initialization next time
}

</script>

>>>>>>> ab435bd1de0cc1b971f9473b0f6e09b5124cf09d
</body>
</html>
