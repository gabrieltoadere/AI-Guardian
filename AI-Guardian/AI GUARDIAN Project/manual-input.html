<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/AI-Guardian/css/manual-input.css" />
  <title>Manual Input</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    input[type="text"], input[type="number"] {
      padding: 8px;
      margin: 5px 0;
      width: 200px;
    }
    #productImage {
      max-width: 200px;
      margin-top: 10px;
    }
    .back-button {
      display: inline-block;
      margin-top: 20px;
      text-decoration: none;
      color: white;
      background-color: #555;
      padding: 10px 15px;
      border-radius: 4px;
    }
    .alternative {
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 10px;
    }

    /* ===== Confirmation Section ===== */
    #confirmSection {
        background-color: #f1f8e9;
        padding: 20px;
        border-radius: 12px;
        margin: 25px 0;
    }

    #questions {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    #questions p {
        text-align: left;
        margin: 10px 0 5px;
        font-weight: 500;
        color: #2d3436;
    }

    #questions input {
        box-sizing: border-box;
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        border: 1px solid #c8e6c9;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    #questions input:focus {
        box-sizing: border-box;
        outline: none;
        border-color: #27ae60;
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
    }

    #saveNotice {
        color: #27ae60;
        font-weight: bold;
        text-align: center;
        margin-top: 15px;
        font-size: 1.1rem;
    }

    #unsafeFoodButton {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    #allergenNotice {
        margin-top: 15px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.1rem;
        display: none; 
    }

    #allergenNotice.safe {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    #allergenNotice.warning {
        background-color: #fdecea;
        color: #c62828;
        border: 1px solid #f5c6cb;
    }    
  </style>
</head>
<body>
  <h1>Manual Barcode Input</h1>

  <div id="manualInput">
    <label for="barcode">Enter Barcode:</label>
    <input type="text" id="barcode" placeholder="Enter barcode">
    <button id="fetchButton" onclick="fetchProductInfo()">Get Ingredients</button>
  </div>

  <div id="result" class="hidden">
    <h2>Product Information</h2>
    <p><strong>Product Name:</strong> <span id="productName">-</span></p>
    <p id="allergyMessage" style="font-weight: bold;"></p>
    <p><strong>Ingredients:</strong> <span id="ingredients">-</span></p>
    <p><strong>Potential Allergens:</strong> <span id="potentialAllergens">-</span></p>
    <p><strong>Nutrient Levels:</strong> <span id="nutrientLevels">-</span></p>
    <p><strong>Sugar:</strong> <span id="sugarLevel">-</span></p>
    <img id="productImage" src="" alt="Product Image" class="hidden">


    <p id="allergenNotice" class=""></p>


    <div id="confirmSection">
        <button id="saftFoodButton" onclick="saveSafeFood(); showQuestions()">Mark this safe food</button>
        <button id="unsafeFoodButton" onclick="saveUnsafeFood()">Mark this unsafe food</button>
        <p id="saveNotice"></p>
        <div id="questions" class="hidden">
            <p>If you purchased this item, how many did you buy?</p>
            <input type="number" placeholder="type number" id="quantity">
            <p>Product Name:</p>
            <input type="text" id="foodNameInput">
            <p>Product Price:</p>
            <input type="text" id="foodPriceInput">
            <button id="confirmButton">Submit</button>
            <p id="trackNotice"></p>
        </div>
    </div>


  </div>

  <a href="scanIndex.html" class="back-button">Back to Main</a>

  <script>

    const user = JSON.parse(localStorage.getItem('currentUser'));
    const userId = user.id;
    //following is just an example
    const allergens = user.allergens;

    let scannedProduct = {
      name:null,
      ingredients:null,
      potential_allergens:null,
      sugar_level:null,
      status:'',
      userId:userId,
      quantity:1,
      price:null
    };

    
    async function fetchProductInfo() {
      const barcode = document.getElementById('barcode').value.trim();
      if (!barcode) {
        alert('Please enter a barcode.');
        return;
      }

      document.getElementById('questions').classList.add('hidden');
      document.getElementById('quantity').value = '';
      document.getElementById('foodNameInput').value = '';
      document.getElementById('foodPriceInput').value = '';
      document.getElementById('trackNotice').textContent = '';

      const url = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;

      try {
          const response = await fetch(url);
          const data = await response.json();

          if (data.status === 1) {
              const product = data.product;

              const productName = product.product_name ||
              product.generic_name_en || 
              product.product_name_en ||
              product.product_name_it ||
              product.generic_name || 
              product.abbreviated_product_name || 
              product.brands || 
              'Unknown Product';

              foodName = productName;	

              const ingredients = product.ingredients_text_en || product.ingredients_text || product.ingredients_hierarchy || product.ingredients_original_tags || 'No ingredients listed';
              const potentialAllergens = product.allergens || 'No data';
              const sugarLevel = product.nutriments.sugars +" " + product.nutriments.sugars_unit || product.nutriments.sugars_100g +" " + product.nutriments.sugars_unit || product.nutriments.sugars_value +" " + product.nutriments.sugars_unit || 'No data';


              scannedProduct.name=productName;
              scannedProduct.ingredients=ingredients;
              scannedProduct.potential_allergens=potentialAllergens;
              scannedProduct.sugar_level=sugarLevel;

              document.getElementById('productName').textContent = productName;
              document.getElementById('ingredients').textContent = ingredients;
              document.getElementById('potentialAllergens').textContent = potentialAllergens;
              document.getElementById('sugarLevel').textContent = sugarLevel;

              const nutrientLevels = product.nutrient_levels || {};
              const nutrientText = Object.entries(nutrientLevels).map(([key, value]) => `${key}: ${value}`).join(", "); 					 
              document.getElementById('nutrientLevels').textContent = nutrientText || "No data";


              document.getElementById('productImage').classList.remove('hidden');
              const imageUrl = product.image_front_small_url || product.selected_images.front.small.it || "https://cdn-icons-png.flaticon.com/512/1178/1178479.png";
              document.getElementById('productImage').src = imageUrl;   
              
              document.getElementById('result').classList.remove('hidden');

              checkAllergens(ingredients);
              document.getElementById('saveNotice').textContent = "";
            } else {
              document.getElementById('productName').textContent = 'Product not found';
              document.getElementById('ingredients').textContent = '-';
              document.getElementById('productImage').classList.add('hidden');
          }

      } catch (error) {
          console.error('Error fetching product info:', error);
          alert('Failed to fetch product information. Please try again.');
      }
  }


  async function checkAllergens(ingredients) {
        const lowerText = ingredients.toLowerCase();
        let allergensInside = "";

        for (const allergen of allergens) {
            if (lowerText.includes(allergen.toLowerCase())){
                allergensInside += allergen + " ";
            }
        }

        const noticeEl = document.getElementById('allergenNotice');
        noticeEl.style.display = 'block';

        noticeEl.classList.remove('safe', 'warning');
        noticeEl.textContent = '';

        if (allergensInside === "") {
            noticeEl.textContent = ' This product is safe for you.';
            noticeEl.classList.add('safe');
        } else {
            noticeEl.textContent = 'Warning! This product contains your allergens: ' + allergensInside;
            noticeEl.classList.add('warning');
        }
    }


    function showQuestions() {
      document.getElementById('questions').classList.remove('hidden');
      document.getElementById('foodNameInput').value = foodName;
    }

    function saveSafeFood() {
        document.getElementById('saveNotice').textContent = 'This product is marked safe.';
        scannedProduct.status='safe';

        //mark this product as save food. And then send food info to dababase
        //later, when users upload receipts, if name on the receipt matches with the products' name, then we can know if it's safe or not.
    }

    async function saveUnsafeFood() {
        document.getElementById('saveNotice').textContent = 'This product is marked unsafe.';
        scannedProduct.status='unsafe';
        console.log(scannedProduct);
        const response  = await fetch('http://localhost:5501/barcodeScan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scannedProduct }),
        });
        //mark this food as unsave food. And then send food info to dababase
        //later, when users upload receipts, if name on the receipt matches with the products' name, then we can know if it's safe or not.
    }

    document.getElementById('confirmButton').addEventListener("click",async () => {
        document.getElementById('trackNotice').textContent = 'Thanks! Your purchase was recorded.';
        scannedProduct.price = parseFloat(document.getElementById('foodPriceInput').value);
        scannedProduct.quantity = parseInt(document.getElementById('quantity').value) ;
        console.log(scannedProduct);
        const response  = await fetch('http://localhost:5501/barcodeScan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ scannedProduct }),
        });
    })
  </script>
</body>
</html>
